<!DOCTYPE html>
<html>
<head>
  <title>Chat - WhatsApp Clone</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }

    h3 {
      margin: 10px;
    }

    a {
      float: right;
      margin-right: 20px;
    }

    .container {
      display: flex;
      height: calc(100vh - 50px);
    }

    #sender-list {
      width: 200px;
      border-right: 1px solid gray;
      padding: 10px;
      overflow-y: auto;
      background: #f2f2f2;
    }

    #sender-list button {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      text-align: left;
      border: none;
      background: #fff;
      cursor: pointer;
      border-radius: 4px;
    }

    #sender-list button:hover {
      background-color: #ddd;
    }

    #chat-box {
      flex: 1;
      padding: 15px;
      display: flex;
      flex-direction: column;
    }

    #messages {
      flex: 1;
      border: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
      margin-bottom: 10px;
      background: #f9f9f9;
    }

    textarea, input, button {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
    }
  </style>
</head>
<body>
  <h3>Welcome, {{ username }} <a href="/logout">Logout</a></h3>
  <div class="container">
    <!-- Sender List -->
    <div id="sender-list">
      <strong>Contacts:</strong>
    </div>

    <!-- Chat Window -->
    <div id="chat-box">
      <div id="messages">Select a user to see messages.</div>

      <!-- Send Text -->
      <form id="send-form">
        <textarea id="message" placeholder="Type your message here..." required></textarea>
        <button type="submit">Send Message</button>
      </form>

      <!-- Send File -->
      <form id="file-form" enctype="multipart/form-data">
        <input type="file" id="file" required>
        <button type="submit">Send File</button>
      </form>
    </div>
  </div>

  <script>
    const user = "{{ username }}";
    let selectedUser = null;
    let allMessages = {};

    async function fetchConversations() {
      const res = await fetch("/api/receive");
      const data = await res.json();
      allMessages = data;

      const senderList = document.getElementById("sender-list");
      senderList.innerHTML = "<strong>Contacts:</strong><br>";

      Object.keys(data).forEach(name => {
        const btn = document.createElement("button");
        btn.textContent = name;
        btn.onclick = () => showChatWith(name);
        senderList.appendChild(btn);
      });

      if (selectedUser) showChatWith(selectedUser);
    }

    function showChatWith(username) {
      selectedUser = username;
      const messagesDiv = document.getElementById("messages");
      messagesDiv.innerHTML = "";

      const msgs = allMessages[username] || [];
      msgs.forEach(msg => {
        let line = `<div><strong>${msg.sender}</strong>: `;
        if (msg.type === "text") {
          line += msg.content;
        } else if (msg.type === "file") {
          line += `<a href="/media/${msg.content}" target="_blank">${msg.content}</a>`;
        }
        line += "</div>";
        messagesDiv.innerHTML += line;
      });

      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    document.getElementById("send-form").addEventListener("submit", async e => {
      e.preventDefault();
      const content = document.getElementById("message").value;
      if (!selectedUser) return alert("Select a user first!");
      await fetch("/api/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ receiver: selectedUser, type: "text", content })
      });
      document.getElementById("message").value = "";
      fetchConversations();
    });

    document.getElementById("file-form").addEventListener("submit", async e => {
      e.preventDefault();
      if (!selectedUser) return alert("Select a user first!");
      const file = document.getElementById("file").files[0];
      const formData = new FormData();
      formData.append("file", file);
      formData.append("receiver", selectedUser);
      await fetch("/api/upload", {
        method: "POST",
        body: formData
      });
      document.getElementById("file").value = "";
      fetchConversations();
    });

    fetchConversations();
    setInterval(fetchConversations, 4000);
  </script>
</body>
</html>
